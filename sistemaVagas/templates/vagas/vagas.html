<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vagas Disponíveis</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/vagas.css' %}">
</head>
<body>
    {% include 'navbar.html' %}

    <!-- Mensagens de Feedback -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <p>{{ message }}</p>
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="container mt-5">
        <div id="sucesso" class="alert" style="display: none;"></div>
        <!-- Botão para Abrir o Modal -->
        {% if superUser == True %}
            <div class="text-end mb-3">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCadastroVaga">
                    Cadastrar Nova Vaga
                </button>
            </div>
        {% endif %}

        <!-- Modal de Cadastro -->
        <div class="modal fade" id="modalCadastroVaga" tabindex="-1" aria-labelledby="modalCadastroVagaLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCadastroVagaLabel">Cadastrar Vaga</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="form-criar-vaga">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="descricao" class="form-label">Descrição</label>
                                <input type="text" class="form-control" id="descricao" name="descricao" required>
                            </div>
                            <div class="mb-3">
                                <label for="faixaSalarial" class="form-label">Faixa Salarial</label>
                                <select class="form-select" id="faixaSalarial" name="faixaSalarial" required>
                                    <option value="1">Até 1.000</option>
                                    <option value="2">De 1.000 à 2.000</option>
                                    <option value="3">De 2.000 à 3.000</option>
                                    <option value="4">Acima de 3.000</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="requisitos" class="form-label">Requisitos</label>
                                <textarea class="form-control" id="requisitos" name="requisitos" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="escolaridade" class="form-label">Escolaridade</label>
                                <select class="form-select" id="escolaridade" name="escolaridade" required>
                                    <option value="1">Ensino Fundamental</option>
                                    <option value="2">Tecnólogo</option>
                                    <option value="3">Ensino Superior</option>
                                    <option value="4">Pós/MBA/Mestrado</option>
                                    <option value="5">Doutorado</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="modalidade" class="form-label">Modalidade</label>
                                <select class="form-select" id="modalidade" name="modalidade" required>
                                    <option value="1">Presencial</option>
                                    <option value="2">Híbrida</option>
                                    <option value="3">Remoto</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="indicadorPCD" class="form-label">Pessoa com Deficiência (PCD)</label>
                                <select class="form-select" id="indicadorPCD" name="indicadorPCD">
                                    <option value="True">Sim</option>
                                    <option value="False">Não</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <button type="submit" class="btn btn-primary">Cadastrar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Vagas -->
        <div class="card p-4">
            <h2 class="text-start text-primary mb-4">Vagas disponíveis</h2>
            <div class="list-group" id="vagas-lista">
                {% if vagas %}
                    {% for vaga in vagas %}
                        <a href="#" class="list-group-item list-group-item-action">
                            <h5 class="mb-1">{{ vaga.descricao }}</h5>
                            <p class="mb-1"><strong>Faixa Salarial:</strong> {{ vaga.get_faixaSalarial_display }}</p>
                            <p class="mb-1"><strong>Requisitos:</strong> {{ vaga.requisitos|linebreaksbr }}</p>
                            <p class="mb-1"><strong>Escolaridade:</strong> {{ vaga.get_escolaridade_display }}</p>
                            <p class="mb-1"><strong>Modalidade:</strong> {{ vaga.get_modalidade_display }}</p>
                            <p class="mb-1"><strong>Inclui PCD?</strong> {{ vaga.indicadorPCD|yesno:"Sim,Não" }}</p>
                            <small>Data de Publicação: {{ vaga.dataPublicacao|date:"d/m/Y" }}</small>
                        </a>
                    {% endfor %}
                {% else %}
                    <p class="text-center">Não há vagas disponíveis no momento.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // Remover mensagens automaticamente
            setTimeout(() => $(".alert").fadeOut("fast"), 3000);

            // Submissão do formulário
            $('#form-criar-vaga').on('submit', function (event) {
                
                event.preventDefault();
                if (validarFormulario()){
                    $.ajax({
                        url: '/cadastrar-vagas/',
                        type: 'POST',
                        data: $(this).serialize(),
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                        success: function (response) {
                            // Feedback ao usuário
                            $('#sucesso')
                                .text(response.mensagem)
                                .removeClass('alert-danger')
                                .addClass('alert-success')
                                .fadeIn();

                            setTimeout(() => $('#sucesso').fadeOut(), 3000);

                            // Atualizar lista de vagas
                            $('#vagas-lista').html(response.vagas);


                            // Resetar formulário e fechar modal
                            $('#form-criar-vaga')[0].reset();
                            $('#modalCadastroVaga').modal('hide');
                        },
                        error: function (error) {
                            const errorMessage = error.responseJSON?.erro || 'Erro ao cadastrar a vaga.';
                            $('#sucesso')
                                .text(errorMessage)
                                .removeClass('alert-success')
                                .addClass('alert-danger')
                                .fadeIn();
                        }
                    });
                }
            });
            function validarFormulario() {
                const descricao = $('#descricao').val();
                if (descricao.length < 5) {
                    alert('A descrição precisa ter pelo menos 5 caracteres.');
                    return false;
                }
                return true;
            }

        });
    </script>
</body>
</html>
